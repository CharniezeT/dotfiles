#!/bin/bash

# Quick-mount

if [ -z "$1" ]
then
  
  # Show help
  echo "Usage: m <filename|dirname>" >&2
  exit 1
  
elif [ -f "$1" ]
then
  
  # Mount TrueCrypt file?
  if [ "${1: -3}" == ".tc" ]
  then
    
    # Check TrueCrypt is installed
    if [ -z "`which truecrypt`" ]
    then
      
      # Not installed
      echo "Cannot find truecrypt in path" >&2
      
    else
      
      # Mount it
      mountdir="${1%.tc}"
      mkdir "$mountdir"
      truecrypt -u "$1" "$mountdir"
      
    fi
    
  else
    
    # Unknown file type
    echo "I do not know what to do with that type of file!" >&2
    exit 1
    
  fi
  
elif [ -d "$1" ]
then
  
  # Look for a file with instructions
  if [ -f "$1/m.sshfs" ]
  then
    
    # Check it's the only thing in the directory before agreeing to mount over it
    if [ "`ls -A $1 | wc -l`" -gt 1 ]
    then
      
      echo "$1/m.sshfs is not the only file in $1 so I won't mount over it" >&2
      exit 1
      
    else
      
      remotepath="`head -1 "$1/m.sshfs"`"
      uid=`id -u`
      gid=`id -g`
      sshfs -o nonempty -o uid=$uid -o gid=$gid $remotepath $1
      
    fi
    
  elif [ -f "$1/m.smbfs" ]
  then
    
    # Check it's the only thing in the directory before agreeing to mount over it
    if [ "`ls -A $1 | wc -l`" -gt 1 ]
    then
      
      echo "$1/m.smbfs is not the only file in $1 so I won't mount over it" >&2
      exit 1
      
    else
      
      remotepath="`head -1 "$1/m.smbfs"`"
      smbmount ${remotepath/\$dir/$1}
      
    fi
    
  elif [ -f "$1/m.ftpfs" ]
  then
    
    # Check it's the only thing in the directory before agreeing to mount over it
    if [ "`ls -A $1 | wc -l`" -gt 1 ]
    then
      
      echo "$1/m.ftpfs is not the only file in $1 so I won't mount over it" >&2
      exit 1
      
    else
      
      remotepath="`head -1 "$1/m.ftpfs"`"
      uid=`id -u`
      gid=`id -g`
      curlftpfs -o nonempty -o uid=$uid -o gid=$gid $remotepath $1
      
    fi
    
  else
    
    # Mount script doesn't exist
    echo "$1/m.sshfs does not exist" >&2
    exit 1
    
  fi
  
else
  
  echo "Invalid directory or filename" >&2
  exit 1
  
fi

