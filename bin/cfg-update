#!/bin/bash

cd $(dirname "$0")/..

# Delete old .hg directory if necessary
# Note: This is because Mercurial writes to the .hg/dirstate after it is
# deleted by the old version of cfg-update!
if [ -d .hg ]; then
    rm -rf .hg
fi

# Create local Mercurial settings file, and chmod to ensure any passwords are protected
if [ ! -e .hgrc_local ]; then
    touch .hgrc_local
    chmod 600 .hgrc_local
fi

# Create local MySQL settings file, and chmod to ensure any passwords are protected
if [ ! -e .my_local.cnf ]; then
    touch .my_local.cnf
    chmod 600 .my_local.cnf
fi

# Check permissions on .ssh/ directory
chmod 700 .ssh
chmod 600 .ssh/*

# Add known host keys for various Git servers
if [ ! -f .ssh/known_hosts ]; then
    touch .ssh/known_hosts
    chmod 600 .ssh/known_hosts
fi

if ! grep -q ^github.com .ssh/known_hosts; then
    echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" >> .ssh/known_hosts
fi

if ! grep -q ^gitlab.com .ssh/known_hosts; then
    echo "gitlab.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCsj2bNKTBSpIYDEGk9KxsGh3mySTRgMtXL583qmBpzeQ+jqCMRgBqB98u3z++J1sKlXHWfM9dyhSevkMwSbhoR8XIq/U0tCNyokEi/ueaBMCvbcTHhO7FcwzY92WK4Yt0aGROY5qX2UKSeOvuP4D6TPqKF1onrSzH9bx9XUf2lEdWT/ia1NEKjunUqu1xOB/StKDHMoX4/OKyIzuS0q/T1zOATthvasJFoPrAjkohTyaDUz2LN5JoH839hViyEG82yB+MjcFV5MU3N1l1QL3cVUCh93xSaua1N85qivl+siMkPGbO5xR/En4iEY6K2XPASUEMaieWVNTRCtJ4S8H+9" >> .ssh/known_hosts
fi

if ! grep -q ^bitbucket.org .ssh/known_hosts; then
    echo "bitbucket.org ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAubiN81eDcafrgMeLzaFPsw2kNvEcqTKl/VqLat/MaB33pZy0y3rJZtnqwR2qOOvbwKZYKiEO1O6VqNEBxKvJJelCq0dTXWT5pbO2gDXC6h6QDXCaHo6pOHGPUy+YBaGQRGuSusMEASYiWunYN0vCAI8QaXnWMXNMdFP3jHAJH0eDsoiGnLPBlBp4TNm6rYI74nMzgz3B9IikW4WVK+dc8KZJZWYjAuORU3jc1c/NPskD2ASinf8v3xnfXeukU0sJ5N6m5E8VLjObPEO+mN2t/FZTMZLiFqPWc/ALSqnMnnhwrNi2rbfg/rd/IpL8Le3pSBne8+seeFVBoGqzHM9yXw==" >> .ssh/known_hosts
fi

# Delete old post-checkout hook
if [ -f .git/hooks/post-checkout ]; then
    rm -f .git/hooks/post-checkout
fi

# Delete old submodules
for i in .vim/bundle/nerdtree-tabs .vim/bundle/slime .vim/bundle/gemfile opt/boris; do
    if [ -d "$i" ]; then
        rm -rf "$i"
    fi
done

# Create post-merge hook
if [ ! -f .git/hooks/post-merge ]; then
    ln -s ../../bin/cfg-update .git/hooks/post-merge
fi

# Add/update remote repositories
git remote add alberon git://github.com/alberon/dotfiles.git 2>/dev/null
git remote remove dd 2>/dev/null

# Update submodules
git submodule sync #>/dev/null
git submodule init #>/dev/null
git submodule update

# Update sub-submodules!
cd opt/git-extras
git submodule sync #>/dev/null
git submodule init #>/dev/null
git submodule update
cd ../..

# Update Node.js packages
if which npm >/dev/null 2>&1; then
    npm install
fi

# Update Composer packages
if which composer >/dev/null 2>&1; then
    composer global install
fi

# Ignore doc/tags in vim-reload submodule
echo -e "/.gitignore\ndoc/tags" > .vim/bundle/vim-reload/.gitignore
