#!/bin/bash

# Check number of params
if [ $# -lt 2 ]; then
  prog=`basename "$0"`
  echo "Usage: $prog <source> <dest>" >&2
  exit 1
fi

src="$1"
dest="$2"

# Check source exists
if [ ! -d "$src" ]; then
  echo "Source directory is not a directory" >&2
  exit 2
fi

# Check source is a git repo
if [ ! -d "$src/.git" ]; then
  echo "Source directory is not a git repository" >&2
  exit 2
fi

# Check the source is fully committed
cd "$src"
if git status >/dev/null; then
  echo "Source repo not fully committed (see git-status)" >&2
  exit 2
fi
  
# Check backup directory doesn't exist
#if [ -d "$src.bak" ]; then
#  echo "Backup directory $src.bak already exists" >&2
#  exit 2
#fi

# Check destination doesn't exist
if [ -e "$dest" ]; then
  echo "Destination already exists" >&2
  exit 2
fi

# Check the destination is writable
if touch "$dest" 2>/dev/null; then
  rm -rf $dest
else
  echo "Destination not writable" >&2
  exit 2
fi

# Convert source & destination to absolute paths
src="$(cd "$(dirname "$src")"; pwd)/$(basename "$src")"
dest="$(cd "$(dirname "$dest")"; pwd)/$(basename "$dest")"

# Clone the source
git clone --bare "$src" "$dest"

# Set the origin of the source to the destination, so push/pull goes there
git config remote.origin.url "$dest"
git config remote.origin.fetch refs/heads/*:refs/remotes/origin/*
git config branch.master.remote origin
git config branch.master.merge refs/heads/master

