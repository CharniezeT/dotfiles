#!/bin/bash

# Check `ssh-agent` is running
# Note: cannot load it because $SSH_AGENT_PID will not be set outside this script
if [ -z "$SSH_AGENT_PID" ] || (! kill -0 "$SSH_AGENT_PID" 2>/dev/null)
then
    echo "ERROR: ssh-agent is not running." >&2
    exit 1
fi

# Check a key has been generated
if [ ! -f ~/.ssh/id_dsa ]
then
    
    # Generate a key
    echo "Creating key..."
    ssh-keygen -t dsa -f ~/.ssh/id_dsa || exit 2
    echo
    
    # Make sure the key is loaded (assume there is only one)
    if [ "`ssh-add -l`" == "The agent has no identities." ]
    then
        echo "Authorising new key..."
        ssh-add
    fi
    echo
    
fi

if [ ! -f ~/.ssh/id_dsa.pub ]
then
    echo "No public key exists in ~/.ssh/id_dsa.pub!" >&2
    exit 3
fi

if [ $# -ge 1 ]; then
    
    # Given at command line
    server="$@"
    
else
    
    # Get the server hostname
    read -r -p "Hostname: " host
    
    if [ -z "$host" ]
    then
        exit 2
    fi
    
    # Get the username (default: current username)
    read -r -p "Username [`whoami`]: " user
    
    if [ -z "$user" ]
    then
        user="`whoami`"
    fi
    
    # Get the port number (default: 22)
    read -r -p "Port [22]: " port
    
    if [ -z "$port" ]
    then
        port=22
    fi
    
    server="-p $port $user@$host"
    
fi

# Upload the public key & set the correct permissions
echo "Uploading key & setting remote permissions (you should be prompted for a password)..."
ssh $server "chmod go-w ~; mkdir ~/.ssh 2>/dev/null; chmod 700 ~/.ssh; cat - >> ~/.ssh/authorized_keys; chmod 600 ~/.ssh/authorized_keys" < ~/.ssh/id_dsa.pub

# Test the connection
echo "Testing (you should NOT be asked for a password)..."
ssh $server 'echo "SUCCESS!"'
